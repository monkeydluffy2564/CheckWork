<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามงาน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f4f7f6;
        }
        .view-container {
            display: none;
        }
        .view-container.active {
            display: block;
        }
        .class-button {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .class-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .failing-student-row {
            background-color: #fee2e2 !important; /* bg-red-100 */
        }
        .failing-student-row:hover {
            background-color: #fecaca !important; /* bg-red-200 */
        }
        .status-A { background-color: #a7f3d0; color: #065f46; } /* Green */
        .status-B { background-color: #bfdbfe; color: #1e40af; } /* Blue */
        .status-C { background-color: #fef08a; color: #854d0e; } /* Yellow */
        .status-D { background-color: #e9d5ff; color: #581c87; } /* Purple */
        .status-none { background-color: #fecaca; color: #991b1b; } /* Red */
        .status-progress { background-color: #e5e7eb; color: #1f2937; } /* Gray for numeric scores */

        #studentDetailTable thead th, #studentSummaryTable thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .table-container {
             max-height: calc(100vh - 250px);
             overflow: auto; /* Changed from overflow-y to auto to allow horizontal scrolling on small screens */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Container -->
    <div class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-6 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex justify-between items-center">
                 <div>
                    <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-gray-800">ระบบติดตามงาน</h1>
                    <p id="subTitle" class="text-gray-500"></p>
                </div>
                <button id="backButton" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-chevron-left mr-2"></i> กลับ
                </button>
            </div>
        </header>

        <!-- View for Class Selection -->
        <div id="class-selection-view" class="view-container active">
            <div id="class-buttons-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Class buttons will be rendered here -->
            </div>
        </div>

        <!-- View for Student Summary in a Class -->
        <div id="student-summary-view" class="view-container">
            <div class="table-container bg-white rounded-xl shadow-sm">
                <table id="studentSummaryTable" class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center">ลำดับที่</th>
                            <th class="px-6 py-3">ชื่อ - สกุล</th>
                            <th class="px-6 py-3 text-center">คะแนนรวม</th>
                            <th class="px-6 py-3 text-center">ผลการเรียน</th>
                        </tr>
                    </thead>
                    <tbody id="studentSummaryBody">
                        <!-- Student summary rows will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- View for a single Student's Details -->
        <div id="student-detail-view" class="view-container">
             <div class="table-container bg-white rounded-xl shadow-sm">
                <table id="studentDetailTable" class="w-full text-sm text-left text-gray-600">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center">ที่</th>
                            <th class="px-6 py-3 w-2/5">ชื่องาน/รายการ</th>
                            <th class="px-4 py-3 text-center">จำนวน</th>
                            <th class="px-4 py-3 text-center">หน้า</th>
                            <th class="px-6 py-3">วันที่มอบหมาย</th>
                            <th class="px-6 py-3 text-center">สถานะ/คะแนน</th>
                        </tr>
                    </thead>
                    <tbody id="studentDetailBody">
                        <!-- Student's assignment details will be rendered here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    document.addEventListener('DOMContentLoaded', async () => {
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_DjUyANiQMWnFSG7d71R_ANviYbrUMM8",
            authDomain: "grading-system-a666b.firebaseapp.com",
            projectId: "grading-system-a666b",
            storageBucket: "grading-system-a666b.appspot.com",
            messagingSenderId: "1008723501468",
            appId: "1:1008723501468:web:d9736312e4f1da107ca859",
            measurementId: "G-JSHX5M64R0"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        await signInAnonymously(auth);
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-public-gradebook-v2';
        const gradebookDocRef = doc(db, "artifacts", appId, "public", "data", "gradebook", "main");

        // --- CONFIGURATION ---
        const GRADE_MULTIPLIER = { 'A': 1.0, 'B': 0.9, 'C': 0.9, 'D': 0.8, 'none': 0 };

        // --- DOM ELEMENTS ---
        const mainTitle = document.getElementById('mainTitle');
        const subTitle = document.getElementById('subTitle');
        const backButton = document.getElementById('backButton');
        const views = {
            classSelection: document.getElementById('class-selection-view'),
            studentSummary: document.getElementById('student-summary-view'),
            studentDetail: document.getElementById('student-detail-view'),
        };
        const classButtonsContainer = document.getElementById('class-buttons-container');
        const studentSummaryBody = document.getElementById('studentSummaryBody');
        const studentDetailBody = document.getElementById('studentDetailBody');

        // --- APP STATE ---
        let fullState = {};
        let currentView = 'classSelection'; // classSelection, studentSummary, studentDetail
        let selectedClassId = null;
        let selectedStudentId = null;

        const setupFirestoreListener = () => {
            onSnapshot(gradebookDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    fullState = docSnap.data();
                    render(); 
                } else {
                    console.log("No document found!");
                    classButtonsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">ไม่พบข้อมูล กรุณาตั้งค่าในแอปหลักก่อน</p>';
                }
            }, (error) => {
                console.error("Error listening to Firestore:", error);
            });
        };
        
        // --- DATA ACCESS HELPERS ---
        const getCurrentAcademicYearData = () => fullState.academicYears ? fullState.academicYears.find(y => y.year === fullState.currentAcademicYear) : null;
        const getCurrentSemesterData = () => {
            const yearData = getCurrentAcademicYearData();
            return yearData ? yearData.semesters.find(s => s.id === fullState.currentSemesterId) : null;
        };
        const getClassData = (classId) => {
            const semesterData = getCurrentSemesterData();
            return semesterData ? semesterData.classData[classId] : null;
        };

        // --- CORE LOGIC & CALCULATIONS ---
        const calculateGpa = (score) => {
            if (score >= 80) return 4.0; if (score >= 75) return 3.5; if (score >= 70) return 3.0;
            if (score >= 65) return 2.5; if (score >= 60) return 2.0; if (score >= 55) return 1.5;
            if (score >= 50) return 1.0; return 0.0;
        };

        const calculateScores = (studentId, classData) => {
            if (!classData) return { totalScore: 0, gpa: '0.0' };
            
            const assignments = classData.assignments || [];
            const studentExams = classData.examScores?.[studentId] || {};
            
            let totalAssignmentPoints = 0;
            const totalWeight = assignments.reduce((sum, a) => sum + (a?.weight || 1), 0);

            if (totalWeight > 0) {
                let studentWeightedScore = assignments.reduce((sum, a) => {
                    if (!a || !a.id) return sum; 
                    const gradeKey = `${studentId}-${a.id}`;
                    const progressScore = classData.progressScores?.[gradeKey];
                    
                    if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                        return sum + (1.0 * (a.weight || 1));
                    }
                    return sum + (GRADE_MULTIPLIER[classData.grades?.[gradeKey] || 'none'] * (a.weight || 1));
                }, 0);
                totalAssignmentPoints = (studentWeightedScore / totalWeight) * (classData.scoreConfig?.assignment || 50);
            }

            const roundedAssignmentScore = Math.ceil(totalAssignmentPoints);

            const specialColumns = classData.specialColumns || [];
            const totalSpecialPoints = specialColumns.reduce((sum, col) => {
                if (!col || !col.id) return sum;
                return sum + (classData.specialScores?.[`${studentId}-${col.id}`] || 0)
            }, 0);
            
            const checklistPoints = ['notebook', 'textbook', 'workbook'].reduce((sum, item) => {
                return sum + (classData.checklistStatus?.[`${studentId}-${item}`] ? 1 : 0);
            }, 0);

            const totalScore = roundedAssignmentScore + 
                               (studentExams.midterm || 0) + 
                               (studentExams.final || 0) + 
                               (studentExams.midYear || 0) + 
                               (studentExams.yearEnd || 0) + 
                               (studentExams.special || 0) + 
                               totalSpecialPoints + 
                               checklistPoints;
                               
            const gpa = calculateGpa(totalScore > 100 ? 100 : totalScore);
            return { totalScore: parseFloat(totalScore.toFixed(2)), gpa: gpa.toFixed(1) };
        };

        // --- NAVIGATION & VIEW MANAGEMENT ---
        const switchView = (viewName) => {
            currentView = viewName;
            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewName]) {
                views[viewName].classList.add('active');
            }
            render();
        };

        backButton.addEventListener('click', () => {
            if (currentView === 'studentDetail') {
                switchView('studentSummary');
            } else if (currentView === 'studentSummary') {
                selectedClassId = null;
                switchView('classSelection');
            }
        });


        // --- MAIN RENDERING LOGIC ---
        const render = () => {
            try {
                const semesterData = getCurrentSemesterData();
                if (!semesterData) {
                    subTitle.textContent = "กรุณาเลือกปีการศึกษาและภาคเรียนในแอปหลัก";
                    return;
                }

                backButton.classList.toggle('hidden', currentView === 'classSelection');

                if (currentView === 'classSelection') {
                    subTitle.textContent = `กรุณาเลือกห้องเรียน | ${semesterData.name}`;
                    renderClassSelection(semesterData);
                } else if (currentView === 'studentSummary' && selectedClassId) {
                    const classData = getClassData(selectedClassId);
                    const className = semesterData.classes.find(c => c.id === selectedClassId)?.name || '';
                    subTitle.textContent = `สรุปผลห้อง ${className}`;
                    renderStudentSummary(classData);
                } else if (currentView === 'studentDetail' && selectedClassId && selectedStudentId) {
                    const classData = getClassData(selectedClassId);
                    const studentName = classData.students.find(s => s.id === selectedStudentId)?.name || '';
                    subTitle.textContent = `รายละเอียดงานของ: ${studentName}`;
                    renderStudentDetail(classData);
                }
            } catch (error) {
                console.error("An error occurred during render:", error);
                subTitle.textContent = "เกิดข้อผิดพลาดในการแสดงผลข้อมูล";
            }
        };

        const renderClassSelection = (semesterData) => {
            classButtonsContainer.innerHTML = '';
            if (!semesterData.classes || semesterData.classes.length === 0) {
                 classButtonsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">ไม่พบห้องเรียนในภาคเรียนนี้</p>';
                 return;
            }
            semesterData.classes.forEach(cls => {
                if (!cls || !cls.id) return;
                const button = document.createElement('button');
                button.className = 'class-button bg-white p-6 rounded-xl shadow-md text-center';
                button.innerHTML = `
                    <div class="text-4xl mb-3"><i class="fas fa-chalkboard-teacher text-indigo-500"></i></div>
                    <h3 class="text-xl font-semibold text-gray-700">${cls.name || 'ไม่มีชื่อ'}</h3>
                `;
                button.addEventListener('click', () => {
                    selectedClassId = cls.id;
                    switchView('studentSummary');
                });
                classButtonsContainer.appendChild(button);
            });
        };

        const renderStudentSummary = (classData) => {
            studentSummaryBody.innerHTML = '';
            if (!classData || !Array.isArray(classData.students) || classData.students.length === 0) {
                 studentSummaryBody.innerHTML = '<tr><td colspan="4" class="text-center p-8 text-gray-500">ไม่พบข้อมูลนักเรียน</td></tr>';
                 return;
            }

            // Add a diagnostic row to show the total number of students found
            const diagnosticRow = document.createElement('tr');
            diagnosticRow.innerHTML = `<td colspan="4" class="p-3 text-center bg-blue-100 text-blue-800 font-semibold">พบข้อมูลนักเรียนทั้งหมด ${classData.students.length} คน</td>`;
            studentSummaryBody.appendChild(diagnosticRow);

            let studentIndex = 0;
            for (const student of classData.students) {
                try {
                    if (!student || typeof student.id === 'undefined') {
                        console.warn("Skipping invalid student data:", student);
                        continue;
                    }
                    const scores = calculateScores(student.id, classData);
                    const isFailing = scores.totalScore < 50;
                    const gpaIsZero = scores.gpa === '0.0';
                    const row = document.createElement('tr');
                    row.className = `border-b hover:bg-gray-100 cursor-pointer ${isFailing ? 'failing-student-row' : ''}`;
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center font-medium">${studentIndex + 1}</td>
                        <td class="px-6 py-3 font-semibold text-gray-900">${student.name || 'ไม่มีชื่อ'}</td>
                        <td class="px-6 py-3 text-center text-lg font-bold ${isFailing ? 'text-red-600' : 'text-green-600'}">${scores.totalScore}</td>
                        <td class="px-6 py-3 text-center text-lg font-bold ${gpaIsZero ? 'text-red-600' : 'text-purple-600'}">${scores.gpa}</td>
                    `;
                    row.addEventListener('click', () => {
                        selectedStudentId = student.id;
                        switchView('studentDetail');
                    });
                    studentSummaryBody.appendChild(row);
                } catch (error) {
                    console.error(`Failed to render student: ${student?.name || 'Unknown'}`, error);
                    // Create a more robust error row
                    const errorRow = document.createElement('tr');
                    errorRow.className = 'border-b bg-red-200';
                    errorRow.innerHTML = `
                        <td class="px-4 py-3 text-center font-medium">${studentIndex + 1}</td>
                        <td class="px-6 py-3 font-semibold text-red-800">${student?.name || 'นักเรียนที่ไม่มีชื่อ'}</td>
                        <td colspan="2" class="px-6 py-3 text-red-800">เกิดข้อผิดพลาดในการแสดงผลข้อมูลของนักเรียนคนนี้</td>
                    `;
                    studentSummaryBody.appendChild(errorRow);
                } finally {
                    // Ensure student index always increments
                    studentIndex++;
                }
            }
        };
        
        const renderStudentDetail = (classData) => {
            studentDetailBody.innerHTML = '';
            let hasContent = false;
            let hasOtherScores = false;

            // --- START: Render Exam and other scores FIRST ---
            const studentExams = classData.examScores?.[selectedStudentId] || {};
            const examTypes = {
                midterm: 'คะแนนสอบกลางภาค', final: 'คะแนนสอบปลายภาค',
                midYear: 'คะแนนสอบกลางปี', yearEnd: 'คะแนนสอบปลายปี',
                special: 'คะแนนพิเศษ (การสอบ)'
            };

            Object.entries(examTypes).forEach(([key, label]) => {
                const score = studentExams[key];
                if (score !== undefined && score !== null && score !== 0) {
                    hasContent = true;
                    hasOtherScores = true;
                    const row = document.createElement('tr');
                    row.className = 'border-b bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center font-semibold text-gray-700"><i class="fas fa-file-alt"></i></td>
                        <td class="px-6 py-3 font-semibold text-gray-700" colspan="4">${label}</td>
                        <td class="px-6 py-3 text-center">
                            <span class="px-3 py-1 text-sm font-bold rounded-full bg-indigo-100 text-indigo-800">${score}</span>
                        </td>
                    `;
                    studentDetailBody.appendChild(row);
                }
            });
            
            const specialColumns = classData.specialColumns || [];
            specialColumns.forEach(col => {
                if (!col || !col.id) return;
                const score = classData.specialScores?.[`${selectedStudentId}-${col.id}`];
                if (score !== undefined && score !== null && score !== 0) {
                    hasContent = true;
                    hasOtherScores = true;
                    const row = document.createElement('tr');
                    row.className = 'border-b bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center font-semibold text-gray-700"><i class="fas fa-star"></i></td>
                        <td class="px-6 py-3 font-semibold text-gray-700" colspan="4">${col.name || 'คะแนนพิเศษ'}</td>
                        <td class="px-6 py-3 text-center">
                            <span class="px-3 py-1 text-sm font-bold rounded-full bg-purple-100 text-purple-800">${score}</span>
                        </td>
                    `;
                    studentDetailBody.appendChild(row);
                }
            });

            const checklistItems = { notebook: 'คะแนนสมุด', textbook: 'คะแนนหนังสือ', workbook: 'คะแนนแบบฝึกหัด' };
            Object.entries(checklistItems).forEach(([key, label]) => {
                const hasItem = classData.checklistStatus?.[`${selectedStudentId}-${key}`];
                if (hasItem) {
                    hasContent = true;
                    hasOtherScores = true;
                    const row = document.createElement('tr');
                    row.className = 'border-b bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center font-semibold text-gray-700"><i class="fas fa-check-circle"></i></td>
                        <td class="px-6 py-3 font-semibold text-gray-700" colspan="4">${label}</td>
                        <td class="px-6 py-3 text-center">
                            <span class="px-3 py-1 text-sm font-bold rounded-full bg-green-100 text-green-800">1</span>
                        </td>
                    `;
                    studentDetailBody.appendChild(row);
                }
            });
            // --- END: Render Exam and other scores ---


            let assignmentIndex = 0;
            if (classData.assignments && classData.assignments.length > 0) {
                 // Add a separator if there were other scores and there are assignments to show
                if (hasOtherScores && classData.assignments.some(a => a.id !== undefined)) {
                    const separatorRow = document.createElement('tr');
                    separatorRow.innerHTML = `<td colspan="6" class="py-2 bg-gray-100"></td>`;
                    studentDetailBody.appendChild(separatorRow);
                }

                for (const assignment of classData.assignments) {
                    try {
                        if (!assignment || typeof assignment.id === 'undefined') {
                            console.warn("Skipping invalid assignment data:", assignment);
                            continue;
                        }
                        hasContent = true;
                        const gradeKey = `${selectedStudentId}-${assignment.id}`;
                        const progressScore = classData.progressScores ? classData.progressScores[gradeKey] : undefined;
                        const grade = classData.grades[gradeKey] || 'none';
                        
                        let statusText, statusClass;
                        if (progressScore !== undefined && progressScore !== null && progressScore !== '') {
                            statusText = progressScore;
                            statusClass = 'status-progress';
                        } else {
                            statusText = grade === 'none' ? '-' : grade;
                            statusClass = `status-${grade}`;
                        }

                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-center">${assignmentIndex + 1}</td>
                            <td class="px-6 py-3">${assignment.name || '-'}</td>
                            <td class="px-4 py-3 text-center">${assignment.quantity || '-'}</td>
                            <td class="px-4 py-3 text-center">${assignment.page || '-'}</td>
                            <td class="px-6 py-3">${assignment.assignedDate || '-'}</td>
                            <td class="px-6 py-3 text-center">
                                <span class="px-3 py-1 text-xs font-bold rounded-full ${statusClass}">${statusText}</span>
                            </td>
                        `;
                        studentDetailBody.appendChild(row);
                        assignmentIndex++;
                    } catch (error) {
                        console.error(`Failed to render assignment: ${assignment?.name || 'Unknown'}`, error);
                    }
                }
            }
            
            if (!hasContent) {
                studentDetailBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-gray-500">ไม่พบรายการงานหรือคะแนนของนักเรียนคนนี้</td></tr>';
            }
        };

        // Start the app
        setupFirestoreListener();
    });
</script>

</body>
</html>

